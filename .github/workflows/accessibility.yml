name: Accessibility Checks (Axe & Pa11y)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Tuesdays at 10 AM UTC
    - cron: '0 10 * * 2'

jobs:
  accessibility:
    name: Run Axe and Pa11y
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install --no-audit --no-fund

      - name: Build Project
        run: npm run build

      - name: Start Preview Server
        run: npm run preview &

      - name: Wait for Server
        run: sleep 5

      - name: Run Pa11y CI
        run: |
          npx pa11y-ci --config ./pa11y-ci.json | tee pa11y-results.txt

      - name: Run Axe CLI - Home
        run: |
          npx @axe-core/cli --tags wcag2a,wcag2aa --exit http://localhost:4173/ | tee axe-home.txt

      - name: Run Axe CLI - Loading Demo
        run: |
          npx @axe-core/cli --tags wcag2a,wcag2aa --exit http://localhost:4173/loading-demo.html | tee axe-loading.txt

      - name: Run Axe CLI - Mobile Test Guide
        run: |
          npx @axe-core/cli --tags wcag2a,wcag2aa --exit http://localhost:4173/mobile-test-guide.html | tee axe-mobile.txt

      - name: Run Axe CLI - Performance Dashboard
        run: |
          npx @axe-core/cli --tags wcag2a,wcag2aa --exit "http://localhost:4173/?perf=1" | tee axe-perf.txt

      - name: Upload Accessibility Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-results
          path: |
            pa11y-results.txt
            axe-home.txt
            axe-loading.txt
            axe-mobile.txt
            axe-perf.txt
          retention-days: 30